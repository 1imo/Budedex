---
interface Strain {
  name: string;
  url: string;
  type: string;
  thc?: number;
  cbd?: number;
  rating?: number;
  review_count?: number;
  top_effect?: string;
  category: string;
  image_path?: string;
  image_url?: string;
  description?: string;
  positive_effects?: string[];
  negative_effects?: string[];
  flavors?: string[];
  terpenes?: string[];
  medical_benefits?: string[];
  parents?: string[];
  children?: string[];
  strainNumber?: number;
}

interface Props {
  selectedStrain?: Strain | null;
}

const { selectedStrain = null } = Astro.props;
---

<div class="pokedex-detail-area">
  <div class="strain-detail-pane" id="strain-detail-pane">
    {selectedStrain ? (
      <!-- Strain Selected -->
      <div class="strain-info bg-white">
        <!-- Image -->
        <div class="mb-6">
          <img
            src={(selectedStrain.image_url ? selectedStrain.image_url.split('?')[0] : `/api/images/${selectedStrain.image_path}`)}
            alt={selectedStrain.name}
            class="w-full aspect-square object-contain"
            loading="lazy"
          />
        </div>
        
        <!-- Header -->
        <div class="text-center mb-4">
          <div class="text-sm text-tui-cyan uppercase tracking-wider mb-1">
            #{selectedStrain.strainNumber || 'XXX'}
          </div>
          <h2 class="text-lg text-tui-green uppercase tracking-wider mb-1">
            {selectedStrain.name}
          </h2>
          <div class="flex justify-center gap-2 mb-2">
            <span class="strain-type">{selectedStrain.category}</span>
            <span class="strain-type">{selectedStrain.type}</span>
          </div>
        </div>
        
        <!-- Quick Stats Grid -->
        <div class="grid grid-cols-2 gap-2 mb-4">
          {selectedStrain.thc && (
            <div class="strain-stat">
              <span class="text-tui-red">THC:</span>
              <span class="text-tui-white">{selectedStrain.thc}%</span>
            </div>
          )}
          {selectedStrain.cbd && (
            <div class="strain-stat">
              <span class="text-tui-blue">CBD:</span>
              <span class="text-tui-white">{selectedStrain.cbd}%</span>
            </div>
          )}
          {selectedStrain.rating && (
            <div class="strain-stat">
              <span class="text-tui-yellow">RATING:</span>
              <span class="text-tui-white">{selectedStrain.rating}/5</span>
            </div>
          )}
          {selectedStrain.review_count && (
            <div class="strain-stat">
              <span class="text-tui-cyan">REVIEWS:</span>
              <span class="text-tui-white">{selectedStrain.review_count}</span>
            </div>
          )}
        </div>
        
        <!-- Description -->
        {selectedStrain.description && (
          <div class="mb-4">
            <div class="text-xs text-tui-green uppercase mb-2">DESCRIPTION:</div>
            <div class="tui-panel p-2 text-xs">
              <p class="text-foreground/90 leading-relaxed">
                {selectedStrain.description.slice(0, 200)}
                {selectedStrain.description.length > 200 && '...'}
              </p>
            </div>
          </div>
        )}
        
        <!-- Primary Effect -->
        {selectedStrain.top_effect && (
          <div class="mb-4">
            <div class="text-xs text-tui-green uppercase mb-1">PRIMARY EFFECT:</div>
            <div class="tui-panel p-2 text-center">
              <span class="text-sm text-tui-yellow uppercase">
                {selectedStrain.top_effect}
              </span>
            </div>
          </div>
        )}
        
        <!-- Effects Grid -->
        <div class="grid grid-cols-1 gap-3 mb-4">
          {selectedStrain.positive_effects && selectedStrain.positive_effects.length > 0 && (
            <div>
              <div class="text-xs text-tui-green uppercase mb-1">POSITIVE EFFECTS:</div>
              <div class="flex flex-wrap gap-1">
                {selectedStrain.positive_effects.slice(0, 6).map((effect: string) => (
                  <span class="text-xs px-2 py-1 bg-tui-green/20 text-tui-green border border-tui-green/50">
                    {effect}
                  </span>
                ))}
              </div>
            </div>
          )}
          
          {selectedStrain.negative_effects && selectedStrain.negative_effects.length > 0 && (
            <div>
              <div class="text-xs text-tui-red uppercase mb-1">SIDE EFFECTS:</div>
              <div class="flex flex-wrap gap-1">
                {selectedStrain.negative_effects.slice(0, 4).map((effect: string) => (
                  <span class="text-xs px-2 py-1 bg-tui-red/20 text-tui-red border border-tui-red/50">
                    {effect}
                  </span>
                ))}
              </div>
            </div>
          )}
          
          {selectedStrain.flavors && selectedStrain.flavors.length > 0 && (
            <div>
              <div class="text-xs text-tui-cyan uppercase mb-1">FLAVORS:</div>
              <div class="flex flex-wrap gap-1">
                {selectedStrain.flavors.slice(0, 5).map((flavor: string) => (
                  <span class="text-xs px-2 py-1 bg-tui-cyan/20 text-tui-cyan border border-tui-cyan/50">
                    {flavor}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>
        
        <!-- Terpenes & Medical -->
        {(selectedStrain.terpenes || selectedStrain.medical_benefits) && (
          <div class="grid grid-cols-1 gap-3 mb-4">
            {selectedStrain.terpenes && selectedStrain.terpenes.length > 0 && (
              <div>
                <div class="text-xs text-tui-magenta uppercase mb-1">TERPENES:</div>
                <div class="flex flex-wrap gap-1">
                  {selectedStrain.terpenes.slice(0, 4).map((terpene: string) => (
                    <span class="text-xs px-2 py-1 bg-purple-500/20 text-purple-400 border border-purple-500/50">
                      {terpene}
                    </span>
                  ))}
                </div>
              </div>
            )}
            
            {selectedStrain.medical_benefits && selectedStrain.medical_benefits.length > 0 && (
              <div>
                <div class="text-xs text-tui-blue uppercase mb-1">MEDICAL:</div>
                <div class="flex flex-wrap gap-1">
                  {selectedStrain.medical_benefits.slice(0, 3).map((benefit: string) => (
                    <span class="text-xs px-2 py-1 bg-blue-500/20 text-blue-400 border border-blue-500/50">
                      {benefit.replace(/\s*\(\d+%\)/, '')}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
        
        <!-- Genetics -->
        {(selectedStrain.parents || selectedStrain.children) && (
          <div class="mb-4">
            <div class="text-xs text-tui-green uppercase mb-2">GENETICS:</div>
            <div class="tui-panel p-2 space-y-2">
              {selectedStrain.parents && selectedStrain.parents.length > 0 && (
                <div>
                  <span class="text-xs text-tui-yellow uppercase">PARENTS:</span>
                  <div class="text-xs text-foreground/80 mt-1">
                    {selectedStrain.parents.slice(0, 2).join(' √ó ')}
                  </div>
                </div>
              )}
              {selectedStrain.children && selectedStrain.children.length > 0 && (
                <div>
                  <span class="text-xs text-tui-yellow uppercase">CHILDREN:</span>
                  <div class="text-xs text-foreground/80 mt-1">
                    {selectedStrain.children.slice(0, 3).join(', ')}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
        
        <!-- Actions -->
        <div class="flex gap-2 mt-4">
          <button class="tui-button primary flex-1" id="catch-btn">
            CATCH
          </button>
          <button class="tui-button flex-1" id="details-btn">
            MORE INFO
          </button>
        </div>
      </div>
    ) : (
      <!-- No Strain Selected -->
      <div class="flex items-center justify-center h-full text-center">
        <div>
          <div class="text-6xl mb-4">üîç</div>
          <h3 class="text-lg text-tui-green uppercase mb-2">SELECT A STRAIN</h3>
          <p class="text-sm text-muted-foreground">
            Click on a strain image to view its details
          </p>
          <div class="mt-4 text-xs text-muted-foreground">
            <p>Navigate using the grid on the left</p>
            <p class="mt-1">Search to filter strains</p>
          </div>
        </div>
      </div>
    )}
  </div>
</div>

<script>
  let currentStrain: any = null;
  
  // Listen for strain selection
  window.addEventListener('strain-selected', (e: any) => {
    const strain = e.detail;  // PokedexGrid sends strain directly as e.detail
    currentStrain = strain;
    updateDetailPane(strain);
    console.log('üîß StrainDetailPane received strain:', strain.name);
  });
  
  function updateDetailPane(strain: any) {
    const detailPane = document.getElementById('strain-detail-pane');
    if (!detailPane) return;
    
    // Check if strain is seen
    const seenStrains = JSON.parse(localStorage.getItem('seen-strains') || '[]');
    const isSeen = seenStrains.includes(strain.name);
    
    console.log(`üîç Strain ${strain.name} is ${isSeen ? 'SEEN' : 'UNSEEN'}`);
    
    const html = `
      <div class="strain-info bg-white">
        <!-- Image -->
        <div class="mb-6">
          <img
            src="${strain.image_url ? strain.image_url.split('?')[0] : `/api/images/${strain.image_path}`}"
            alt="${strain.name}"
            class="w-full aspect-square object-contain ${isSeen ? '' : 'force-ghost'}"
            loading="lazy"
          />
        </div>
        
        <!-- Header -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm text-tui-cyan uppercase tracking-wider">
              #${strain.strainNumber || 'XXX'}
            </div>
            ${isSeen && strain.rating ? `
              <div class="flex items-center gap-1">
                ${Array.from({length: Math.floor(strain.rating)}, () => '‚òÖ').join('')}
                <span class="text-xs text-tui-yellow ml-1">${strain.rating}/5</span>
              </div>
            ` : ''}
          </div>
          <h1 class="text-2xl text-tui-green uppercase tracking-wider font-bold mb-3">
            ${isSeen ? strain.name : '???'}
          </h1>
          <div class="flex items-center gap-4 mb-4">
            <span class="text-sm text-tui-gray uppercase">
              ${isSeen ? (strain.category || 'HYBRID') : '???'}
            </span>
            ${isSeen && strain.thc ? `
              <span class="text-sm text-tui-gray uppercase">
                THC: ${strain.thc.replace('THC ', '')}%
              </span>
            ` : (!isSeen ? `
              <span class="text-sm text-tui-gray uppercase">
                THC: ???%
              </span>
            ` : '')}
          </div>
        </div>
        
        <!-- Description -->
        <div class="mb-6">
          <div class="text-sm font-bold text-tui-green mb-3 uppercase">Description</div>
          <div class="bg-gray-50 p-4 rounded-lg text-sm leading-relaxed">
            ${isSeen && strain.description 
              ? `${strain.description.slice(0, 200)}${strain.description.length > 200 ? '...' : ''}`
              : 'This strain data is not yet available. Catch this strain to unlock its details!'
            }
          </div>
        </div>
        
        <!-- Primary Effect -->
        ${isSeen && strain.top_effect ? `
          <div class="mb-6">
            <div class="text-sm font-bold text-tui-green mb-3 uppercase">Primary Effect</div>
            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-center">
              <span class="text-lg font-bold text-yellow-800 uppercase">
                ${strain.top_effect}
              </span>
            </div>
          </div>
        ` : (!isSeen ? `
          <div class="mb-6">
            <div class="text-sm font-bold text-tui-green mb-3 uppercase">Primary Effect</div>
            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg text-center">
              <span class="text-lg font-bold text-gray-400 uppercase">
                ???
              </span>
            </div>
          </div>
        ` : '')}
        
        <!-- Effects & Properties Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8 mb-6">
          <div>
            <h4 class="font-medium text-green-600 mb-3 uppercase">Positive Effects</h4>
            <div class="flex flex-wrap gap-2">
              ${isSeen && strain.positive_effects && strain.positive_effects.length > 0
                ? (Array.isArray(strain.positive_effects) 
                    ? strain.positive_effects.slice(0, 6).map(effect => `
                      <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                        ${effect}
                      </span>
                    `).join('')
                    : strain.positive_effects.split(',').slice(0, 6).map(effect => `
                      <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                        ${effect.trim()}
                      </span>
                    `).join(''))
                : Array.from({length: 3}, () => `
                  <span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-sm">
                    ???
                  </span>
                `).join('')
              }
            </div>
          </div>
          
          <div>
            <h4 class="font-medium text-red-600 mb-3 uppercase">Side Effects</h4>
            <div class="flex flex-wrap gap-2">
              ${isSeen && strain.negative_effects && strain.negative_effects.length > 0
                ? (Array.isArray(strain.negative_effects)
                    ? strain.negative_effects.slice(0, 4).map(effect => `
                      <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm">
                        ${effect}
                      </span>
                    `).join('')
                    : strain.negative_effects.split(',').slice(0, 4).map(effect => `
                      <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm">
                        ${effect.trim()}
                      </span>
                    `).join(''))
                : Array.from({length: 3}, () => `
                  <span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-sm">
                    ???
                  </span>
                `).join('')
              }
            </div>
          </div>
          
          <div>
            <h4 class="font-medium text-purple-600 mb-3 uppercase">Flavor Profile</h4>
            <div class="flex flex-wrap gap-2">
              ${isSeen && strain.flavors && strain.flavors.length > 0
                ? (Array.isArray(strain.flavors)
                    ? strain.flavors.slice(0, 5).map(flavor => `
                      <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">
                        ${flavor}
                      </span>
                    `).join('')
                    : strain.flavors.split(',').slice(0, 5).map(flavor => `
                      <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">
                        ${flavor.trim()}
                      </span>
                    `).join(''))
                : Array.from({length: 2}, () => `
                  <span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-sm">
                    ???
                  </span>
                `).join('')
              }
            </div>
          </div>
          
          <div>
            <h4 class="font-medium text-indigo-600 mb-3 uppercase">Terpene Profile</h4>
            <div class="flex flex-wrap gap-2">
              ${isSeen && strain.terpenes && strain.terpenes.length > 0
                ? (Array.isArray(strain.terpenes)
                    ? strain.terpenes.slice(0, 4).map(terpene => `
                      <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm">
                        ${terpene}
                      </span>
                    `).join('')
                    : strain.terpenes.split(',').slice(0, 4).map(terpene => `
                      <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm">
                        ${terpene.trim()}
                      </span>
                    `).join(''))
                : Array.from({length: 3}, () => `
                  <span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-sm">
                    ???
                  </span>
                `).join('')
              }
            </div>
          </div>
        </div>
        
        <!-- Medical Benefits -->
        ${isSeen && strain.medical_benefits && strain.medical_benefits.length > 0 ? `
          <div class="bg-card rounded-none px-0 py-6">
            <h3 class="text-lg font-bold mb-4 uppercase text-primary">Medical Benefits</h3>
            <div class="space-y-4">
              ${(Array.isArray(strain.medical_benefits)
                ? strain.medical_benefits.slice(0, 3)
                : strain.medical_benefits.split(',').slice(0, 3)
              ).map(benefit => {
                const match = benefit.trim().match(/^(.*?)\\s*\\((\\d+)%\\)$/);
                if (match) {
                  const [, condition, percentage] = match;
                  return `
                    <div class="space-y-2">
                      <div class="flex justify-between items-center">
                        <span class="font-medium">${condition}</span>
                        <span class="text-sm text-muted-foreground">${percentage}% of users</span>
                      </div>
                      <div class="w-full bg-blue-100 rounded-none h-2 overflow-hidden">
                        <div class="h-full bg-blue-500 rounded-none transition-all duration-300" style="width: ${percentage}%"></div>
                      </div>
                    </div>
                  `;
                } else {
                  return `
                    <div class="flex flex-wrap gap-2">
                      <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                        ${benefit.trim()}
                      </span>
                    </div>
                  `;
                }
              }).join('')}
            </div>
          </div>
        ` : (!isSeen ? `
          <div class="bg-card rounded-none px-0 py-6">
            <h3 class="text-lg font-bold mb-4 uppercase text-primary">Medical Benefits</h3>
            <div class="space-y-4">
              ${Array.from({length: 3}, () => `
                <div class="space-y-2">
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-400">???</span>
                    <span class="text-sm text-gray-400">???% of users</span>
                  </div>
                  <div class="w-full bg-gray-100 rounded-none h-2 overflow-hidden">
                    <div class="h-full bg-gray-300 rounded-none" style="width: 0%"></div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : '')}
        
        <!-- Genetics -->
        <div class="mb-6">
          <h3 class="text-lg font-bold mb-4 uppercase text-primary">Genetics</h3>
          <div class="bg-gray-50 p-4 rounded-lg space-y-3">
            <div>
              <span class="font-bold text-yellow-700 uppercase">Parents:</span>
              <div class="text-sm text-gray-700 mt-1">
                ${isSeen && strain.parents && strain.parents.length > 0
                  ? (Array.isArray(strain.parents) 
                      ? strain.parents.slice(0, 2).join(' √ó ')
                      : strain.parents.split(',').slice(0, 2).map((p: any) => p.trim()).join(' √ó '))
                  : '??? √ó ???'
                }
              </div>
            </div>
            <div>
              <span class="font-bold text-yellow-700 uppercase">Children:</span>
              <div class="text-sm text-gray-700 mt-1">
                ${isSeen && strain.children && strain.children.length > 0
                  ? (Array.isArray(strain.children)
                      ? strain.children.slice(0, 3).join(', ')
                      : strain.children.split(',').slice(0, 3).map((c: any) => c.trim()).join(', '))
                  : '???'
                }
              </div>
            </div>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="mb-6">
          <div class="flex gap-3">
            <button class="tui-button primary flex-1" id="catch-btn" title="Mark as Caught">
              CATCH
            </button>
            <button class="tui-button flex-1" id="details-btn" title="More Information">
              MORE INFO
            </button>
          </div>
        </div>
      </div>
    `;
    
    detailPane.innerHTML = html;
    
    // Re-attach event listeners
    setupDetailPaneListeners();
  }
  
  function setupDetailPaneListeners() {
    const catchBtn = document.getElementById('catch-btn');
    const detailsBtn = document.getElementById('details-btn');
    
    if (catchBtn && currentStrain) {
      catchBtn.addEventListener('click', () => {
        toggleCatch(currentStrain);
      });
    }
    
    if (detailsBtn && currentStrain) {
      detailsBtn.addEventListener('click', () => {
        window.location.href = `/strains/${currentStrain.url}`;
      });
    }
  }
  
  function toggleCatch(strain: any) {
    const caughtStrains = JSON.parse(localStorage.getItem('caught-strains') || '[]');
    const isCaught = caughtStrains.includes(strain.name);
    
    if (isCaught) {
      // Remove from caught
      const index = caughtStrains.indexOf(strain.name);
      if (index > -1) {
        caughtStrains.splice(index, 1);
      }
    } else {
      // Add to caught
      caughtStrains.push(strain.name);
    }
    
    localStorage.setItem('caught-strains', JSON.stringify(caughtStrains));
    
    // Update button text
    const catchBtn = document.getElementById('catch-btn');
    if (catchBtn) {
      catchBtn.textContent = isCaught ? 'CATCH' : 'RELEASE';
    }
    
    // Update strain sprite indicator
    const strainSprite = document.querySelector(`[data-strain="${strain.name}"]`);
    if (strainSprite) {
      const indicator = strainSprite.querySelector('.bg-tui-red');
      if (!isCaught && !indicator) {
        const newIndicator = document.createElement('div');
        newIndicator.className = 'absolute top-1 right-1 w-2 h-2 bg-tui-red rounded-full';
        strainSprite.appendChild(newIndicator);
      } else if (isCaught && indicator) {
        indicator.remove();
      }
    }
    
    // Update stats
    window.dispatchEvent(new CustomEvent('strain-stats-updated'));
  }
  
  // Initialize detail pane listeners on load
  document.addEventListener('DOMContentLoaded', setupDetailPaneListeners);
</script>

<style>
  .strain-info {
    animation: fadeIn 0.2s ease;
    flex: 1;
    min-height: 0;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Mobile adjustments */
  @media (max-width: 768px) {
    .strain-detail-image {
      width: 96px;
      height: 96px;
    }
    
    .strain-detail-pane {
      max-height: 280px;
    }
  }
</style>