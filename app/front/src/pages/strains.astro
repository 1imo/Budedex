---
import Layout from '../components/layouts/Layout.astro';
import { getStrains } from '../services/graphql';
import PixelStrainCard from '../components/PixelStrainCard.astro';

// Get page number from URL params
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1');
const limit = 24; // Show 24 strains per page

// Fetch strains data
let strainsData = null;
let error = null;

try {
  strainsData = await getStrains(page, limit);
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to fetch strains';
}
---

<Layout title="Browse Strains - Budedex">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-12 bg-card p-8 rounded-none">
      <h1 class="text-4xl font-bold mb-4 pixel-font uppercase tracking-wider">CANNABIS STRAINS</h1>
      <p class="text-xl max-w-2xl mx-auto uppercase regular-font">
        EXPLORE OUR COMPREHENSIVE DATABASE OF CANNABIS STRAINS. DISCOVER EFFECTS, FLAVORS, AND FIND THE PERFECT STRAIN FOR YOU.
      </p>
    </div>

    {error && (
      <div class="pixel__container bg-destructive text-destructive-foreground px-4 py-3 rounded-none mb-6 box-shadow-margin">
        <p class="pixel-font uppercase">ERROR LOADING STRAINS: {error}</p>
      </div>
    )}

    {strainsData && (
      <div>
        <!-- Strain Categories -->
        <div class="mb-8 bg-muted rounded-none p-8">
          <h3 class="text-xl font-bold mb-6 text-center pixel-font uppercase">STRAIN CATEGORIES</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
            <div class="bg-card p-4 rounded-none">
              <h4 class="text-lg font-bold text-primary mb-2 pixel-font uppercase">SATIVA</h4>
              <p class="text-sm pixel-font uppercase">ENERGIZING AND UPLIFTING EFFECTS</p>
            </div>
            <div class="bg-card p-4 rounded-none">
              <h4 class="text-lg font-bold text-primary mb-2 pixel-font uppercase">INDICA</h4>
              <p class="text-sm pixel-font uppercase">RELAXING AND CALMING EFFECTS</p>
            </div>
            <div class="bg-card p-4 rounded-none">
              <h4 class="text-lg font-bold text-primary mb-2 pixel-font uppercase">HYBRID</h4>
              <p class="text-sm pixel-font uppercase">BALANCED COMBINATION OF EFFECTS</p>
            </div>
          </div>
        </div>

        <!-- Stats Bar -->
        <div class="bg-muted rounded-none p-4 mb-8">
          <div class="flex justify-between items-center flex-wrap gap-4">
            <div class="text-sm pixel-font uppercase">
              SHOWING {((page - 1) * limit) + 1}-{Math.min(page * limit, strainsData.strains.pageInfo.total)} 
              OF {strainsData.strains.pageInfo.total} STRAINS
            </div>
            <div class="text-sm font-bold pixel-font uppercase text-primary">
              PAGE {page} OF {strainsData.strains.pageInfo.totalPages}
            </div>
          </div>
        </div>

        <!-- Strains Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">
          {strainsData.strains.strains.map((strain: any) => (
            <PixelStrainCard strain={strain} />
          ))}
        </div>

        <!-- Pagination -->
        {strainsData.strains.pageInfo.totalPages > 1 && (
          <div class="bg-muted rounded-none p-4">
            <div class="flex justify-center items-center space-x-4 flex-wrap gap-4">
              {strainsData.strains.pageInfo.hasPreviousPage && (
                <a 
                  href={`/strains?page=${page - 1}`} 
                  class="pixel__button pixel-secondary__button box-shadow-margin text-sm font-medium px-4 py-2 uppercase"
                >
                  PREVIOUS
                </a>
              )}
              
              <div class="bg-card p-2 rounded-none">
                <span class="text-sm font-bold pixel-font uppercase text-primary">
                  PAGE {page} OF {strainsData.strains.pageInfo.totalPages}
                </span>
              </div>
              
              {strainsData.strains.pageInfo.hasNextPage && (
                <a 
                  href={`/strains?page=${page + 1}`}
                  class="pixel__button pixel-secondary__button box-shadow-margin text-sm font-medium px-4 py-2 uppercase"
                >
                  NEXT
                </a>
              )}
            </div>
          </div>
        )}
      </div>
    )}
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
